trigger: none

pool:
  vmImage: ubuntu-latest




steps:
  # Step 1: Retreive Last backup compliance json from GitHub
- task: PowerShell@2
  displayName: 'Retrieve Latest Policy JSON from GitHub'
  env:
    GITHUB_TOKEN: $(GITHUB_TOKEN)
  inputs:
    targetType: 'inline'
    pwsh: true
    script: |
      $repo = "mattljordan/CCUATLab-Testing-"
      $apiUrl = "https://api.github.com/repos/$repo/contents"
      $headers = @{
        Authorization = "token $env:GITHUB_TOKEN"
        "User-Agent" = "AzureDevOpsPipeline"
      }

      # Get list of files in the repo root
      $files = Invoke-RestMethod -Uri $apiUrl -Headers $headers
      $jsonFiles = $files | Where-Object { $_.name -like "policy-*.json" }

      if (-not $jsonFiles) {
        Write-Error "No policy-*.json files found in the repo."
        exit 1
      }

      # Get the latest file by name (assuming timestamped)
      $latestFile = $jsonFiles | Sort-Object name -Descending | Select-Object -First 1
      Write-Host "Latest backup file: $($latestFile.name)"

      # Download the file content (raw URL)
      $policyJson = Invoke-RestMethod -Uri $latestFile.download_url -Headers $headers

      # $policyJson is likely a PSCustomObject, convert to string for preview
      $policyJsonString = $policyJson | ConvertTo-Json -Depth 10
      Write-Host "First 200 chars of policy JSON: $($policyJsonString.Substring(0, [Math]::Min(200, $policyJsonString.Length)))"